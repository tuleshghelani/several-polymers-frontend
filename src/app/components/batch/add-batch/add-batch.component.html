<div class="add-batch-container" *ngIf="form">
  <app-loader *ngIf="loading"></app-loader>

  <div class="header">
    <h2>{{ isEdit ? 'Edit Batch' : 'Add Batch' }}</h2>
    <div class="actions">
      <button class="btn secondary" type="button" (click)="refreshMachines()">Refresh Machines</button>
      <button class="btn primary" type="button" (click)="submit()">{{ isEdit ? 'Update' : 'Create' }}</button>
    </div>
  </div>

  <form [formGroup]="form" class="form-grid premium-grid">
    <div class="row">
      <div class="form-row col-4">
        <label>Date</label>
        <input type="date" formControlName="date" />
      </div>
      <div class="form-row col-4">
        <label>Shift</label>
        <select formControlName="shift">
          <option value="D">Day</option>
          <option value="N">Night</option>
        </select>
      </div>
      <div class="form-row col-4">
        <label>Machine</label>
        <app-searchable-select formControlName="machineId" [options]="machines" [labelKey]="'name'" [valueKey]="'id'" placeholder="Select machine"></app-searchable-select>
        <div class="error" *ngIf="(form.get('machineId')?.invalid && form.get('machineId')?.touched) || (submitted && form.get('machineId')?.invalid)">Machine is required</div>
      </div>
    </div>

    <div class="row">
      <div class="form-row col-12">
        <label>Operator <span class="optional">(Optional)</span></label>
        <input 
          type="text" 
          formControlName="operator" 
          placeholder="Enter operator name (optional)"
          class="operator-input"
        />
        <div class="error" *ngIf="(form.get('operator')?.invalid && form.get('operator')?.touched) || (submitted && form.get('operator')?.invalid)">
          <span *ngIf="form.get('operator')?.errors?.['minlength']">Operator name must be at least 2 characters</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="form-row col-3">
        <label>Resign Bag Use (KG)</label>
        <input type="number" step="0.001" formControlName="resignBagUse" />
        <small class="hint">≈ {{ getResignUseBags() }} bag(s)  25 KG</small>
      </div>
      <div class="form-row col-3">
        <label>Resign Bag Opening Stock (KG)</label>
        <input type="number" formControlName="resignBagOpeningStock" readonly />
      </div>
      <div class="form-row col-3">
        <label>CPW Bag Use (Bag)</label>
        <input type="number" step="0.001" formControlName="cpwBagUse" />
      </div>
      <div class="form-row col-3">
        <label>CPW Bag Opening Stock (KG)</label>
        <input type="number" formControlName="cpwBagOpeningStock" readonly />
        <small class="hint">≈ {{ getCpwOpeningBags() }} bag(s)  250 KG</small>
      </div>
    </div>
  <div class="panes">
      <div class="pane left">
      <div class="pane-header">
        <h3>Mixer</h3>
        <button class="btn small" type="button" (click)="addMixer()">Add</button>
      </div>
      <div formArrayName="mixer" class="list">
        <div class="error" *ngIf="(submitted || mixerArray.touched) && mixerArray.invalid">Add at least one mixer item</div>
        <div class="item" *ngFor="let group of mixerArray.controls; let i = index" [formGroupName]="i">
          <div class="item-grid">
            <app-searchable-select class="full" formControlName="productId" [options]="products" [labelKey]="'name'" [valueKey]="'id'" placeholder="Select product"></app-searchable-select>
            <input type="number" step="0.001" min="0.001" placeholder="Quantity (KG)" formControlName="quantity" />
            <button type="button" class="icon danger" (click)="removeMixer(i)">✕</button>
          </div>
          <div class="error" *ngIf="(submitted || group.touched) && group.get('productId')?.invalid">Product is required</div>
          <div class="error" *ngIf="(submitted || group.touched) && group.get('quantity')?.invalid">Valid quantity is required</div>
        </div>
      </div>
    </div>

      <div class="pane right">
      <div class="pane-header">
        <h3>Production</h3>
        <button class="btn small" type="button" (click)="addProduction()">Add</button>
      </div>
      <div formArrayName="production" class="list">
        <div class="error" *ngIf="(submitted || productionArray.touched) && productionArray.invalid">Add at least one production item</div>
        <div class="item" *ngFor="let group of productionArray.controls; let i = index" [formGroupName]="i">
          <div class="item-grid">
            <app-searchable-select class="full" formControlName="productId" [options]="products" [labelKey]="'name'" [valueKey]="'id'" placeholder="Select product"></app-searchable-select>
            <input type="number" step="0.001" min="0.001" placeholder="Quantity (KG)" formControlName="quantity" />
            <input type="number" step="1" placeholder="No. of Rolls" formControlName="numberOfRoll" />
            <div class="checkbox-container">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="isWastage" class="checkbox-input" />
                <span class="checkbox-custom"></span>
                <span class="checkbox-text">Wastage</span>
              </label>
            </div>
            <button type="button" class="icon danger" (click)="removeProduction(i)">✕</button>
          </div>
          <div class="error" *ngIf="(submitted || group.touched) && group.get('productId')?.invalid">Product is required</div>
          <div class="error" *ngIf="(submitted || group.touched) && group.get('quantity')?.invalid">Valid quantity is required</div>
          <!-- <div class="error" *ngIf="(submitted || group.touched) && group.get('numberOfRoll')?.invalid">Number of rolls must be at least 1</div> -->
        </div>
      </div>
    </div>
  </div>
  </form>
</div>
