<div class="transport-container">
  <div class="form-card">
    <div class="card-header">
      <div class="header-content">
        <h2 class="form-title">
          <i class="fas fa-truck"></i> 
          {{ isEditMode ? 'Edit Transport Entry' : 'Create Transport Entry' }}
        </h2>
        <button 
          *ngIf="isEditMode && transportId"
          class="btn btn-primary print-btn" 
          (click)="onPrint()"
          [disabled]="loading || isPrinting"
        >
          <i class="fas" [ngClass]="isPrinting ? 'fa-spinner fa-spin' : 'fa-print'"></i>
          {{ isPrinting ? 'Printing...' : 'Print' }}
        </button>
      </div>
    </div>
    
    <div class="form-content">
      <app-loader [show]="loading"></app-loader>
      
      <form [formGroup]="transportForm" (ngSubmit)="onSubmit()" class="transport-form" [class.loading]="loading">
        <!-- Customer and Total Weight Section -->
        <div class="customer-section">
          <div class="customer-weight-row">
            <div class="form-group customer-select">
              <label for="customerId">
                <i class="fas fa-user"></i> Select Customer <span class="required">*</span>
              </label>
              <div class="customer-select-group">
                <app-searchable-select
                  formControlName="customerId"
                  [options]="customers"
                  labelKey="name"
                  valueKey="id"
                  [placeholder]="'Select Customer'"
                  [defaultOption]="{ label: 'Select Customer', value: '' }"
                  [searchPlaceholder]="'Search customers...'"
                  [class.is-invalid]="isFieldInvalid(transportForm.get('customerId'))"
                ></app-searchable-select>
                <button type="button" class="btn-icon refresh" (click)="refreshCustomers()">
                  <i class="fas" [ngClass]="isLoadingCustomers ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                </button>
              </div>
              <div class="invalid-feedback" *ngIf="isFieldInvalid(transportForm.get('customerId'))">
                Please select a customer
              </div>
            </div>

            <div class="total-weight">
              <label><i class="fas fa-weight-hanging"></i> Total Weight</label>
              <div class="weight-value">{{ calculateTotalWeight() | number:'1.3-3' }} kg</div>
            </div>
          </div>
        </div>

        <!-- Add this section after the customer selection -->
        <div class="transport-summary" *ngIf="isEditMode && transportSummary">
          <div class="summary-card">
            <div class="summary-header">
              <h3><i class="fas fa-chart-pie"></i> Transport Summary</h3>
              <span class="created-at">Created: {{ transportSummary.createdAt | date:'medium' }}</span>
            </div>
            <div class="summary-content">
              <div class="summary-item">
                <label>Total Bags</label>
                <span>{{ transportSummary.totalBags }}</span>
              </div>
              <div class="summary-item">
                <label>Total Weight</label>
                <span>{{ transportSummary.totalWeight | number:'1.3-3' }} kg</span>
              </div>
              <div class="summary-item">
                <label>Total Purchase</label>
                <span>₹{{ transportSummary.totalPurchaseAmount | number:'1.2-2' }}</span>
              </div>
              <div class="summary-item">
                <label>Total Sale</label>
                <span>₹{{ transportSummary.totalSaleAmount | number:'1.2-2' }}</span>
              </div>
              <div class="summary-item profit">
                <label>Total Profit</label>
                <span>₹{{ transportSummary.totalProfit | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Bags Section -->
        <div class="bags-section" formArrayName="bags">

          <div class="bags-list" *ngIf="bags.length > 0">
            <div class="bag-card" *ngFor="let bag of bags.controls; let bagIndex = index" [formGroupName]="bagIndex">
              <div class="bag-header">
                <h4>{{ getBagTitle(bagIndex) }}</h4>
                <div class="bag-controls">
                  <div class="form-group number-of-bags">
                    <label>
                      <i class="fas fa-shopping-bag"></i> Number of Bags
                    </label>
                    <input 
                      type="number" 
                      formControlName="numberOfBags" 
                      class="form-control"
                      min="1"
                      [class.is-invalid]="isFieldInvalid(bag.get('numberOfBags'))"
                    >
                  </div>
                  <div class="form-group bag-weight">
                    <label>
                      <i class="fas fa-weight"></i> Bag Weight (kg)
                    </label>
                    <input 
                      type="number" 
                      formControlName="weight" 
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid(bag.get('weight'))"
                      min="0.01"
                      step="0.01"
                    >
                  </div>
                  <div class="form-group total-bag-weight">
                    <label>
                      <i class="fas fa-balance-scale"></i> Total Bag Weight
                    </label>
                    <input 
                      type="number" 
                      [value]="calculateTotalBagWeight(bagIndex)"
                      class="form-control"
                      readonly
                    >
                  </div>
                </div>
                <button 
                  type="button" 
                  class="btn btn-danger remove-bag-btn" 
                  (click)="onDeleteBag(bagIndex)"
                  [disabled]="bags.length === 1"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>

              <!-- <div class="bag-weight">
                <div class="form-group">
                  <label>
                    <i class="fas fa-weight"></i> Weight (kg) <span class="required">*</span>
                  </label>
                  <input 
                    type="number" 
                    formControlName="weight" 
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid(bag.get('weight'))"
                    min="0.01"
                    step="0.01"
                  >
                  <div class="invalid-feedback" *ngIf="isFieldInvalid(bag.get('weight'))">
                    {{ getCustomErrorMessage(bag.get('weight'), 'weight') }}
                  </div>
                </div>
              </div> -->

              <div class="items-section" formArrayName="items">
                <div class="items-header">
                  <h5>Items</h5>
                  <button 
                    type="button" 
                    class="btn btn-secondary add-item-btn" 
                    (click)="addItem(bagIndex)"
                  >
                    <i class="fas fa-plus"></i> Add Item
                  </button>
                </div>

                <div class="items-list">
                  <div 
                    class="item-row" 
                    *ngFor="let item of getBagItems(bagIndex).controls; let itemIndex = index" 
                    [formGroupName]="itemIndex"
                  >
                    <div class="basic-info-row">
                      <div class="form-group product-select">
                        <label>Product <span class="required">*</span></label>
                        <div class="product-select-group">
                          <app-searchable-select
                            formControlName="productId"
                            [options]="products"
                            [class.is-invalid]="isFieldInvalid(item.get('productId'))"
                          ></app-searchable-select>
                          <button type="button" class="btn-icon refresh" (click)="refreshProducts()">
                            <i class="fas fa-sync-alt"></i>
                          </button>
                        </div>
                        <div class="invalid-feedback" *ngIf="isFieldInvalid(item.get('productId'))">
                          Please select a product
                        </div>
                      </div>

                      <div class="form-group quantity-input">
                        <label>Quantity <span class="required">*</span></label>
                        <div class="quantity-group">
                          <input 
                            type="number" 
                            formControlName="quantity" 
                            class="form-control"
                            [class.is-invalid]="isFieldInvalid(item.get('quantity'))"
                            min="1"
                          >
                          <div class="total-quantity" *ngIf="item.get('totalQuantity')?.value !== item.get('quantity')?.value">
                            Total: {{ item.get('totalQuantity')?.value }}
                          </div>
                        </div>
                        <div class="invalid-feedback" *ngIf="isFieldInvalid(item.get('quantity'))">
                          Please enter a valid quantity
                        </div>
                      </div>

                      <div class="form-group remarks-input">
                        <label>Remarks</label>
                        <input 
                          type="text" 
                          formControlName="remarks" 
                          class="form-control"
                          placeholder="Optional remarks"
                        >
                      </div>
                    </div>

                    <!-- Purchase Section -->
                    <div class="purchase-section">
                      <h6 class="section-title"><i class="fas fa-shopping-cart"></i> Purchase Details</h6>
                      <div class="price-details">
                        <div class="form-group">
                          <label>Unit Price <span class="required">*</span></label>
                          <input 
                            type="number" 
                            formControlName="purchaseUnitPrice" 
                            class="form-control"
                            [class.is-invalid]="isFieldInvalid(item.get('purchaseUnitPrice'))"
                            min="0"
                            step="0.01"
                          >
                          <div class="invalid-feedback" *ngIf="isFieldInvalid(item.get('purchaseUnitPrice'))">
                            {{ item.get('purchaseUnitPrice')?.errors?.['required'] ? 'Unit price is required' : 
                               item.get('purchaseUnitPrice')?.errors?.['min'] ? 'Unit price must be greater than 0' : '' }}
                          </div>
                        </div>

                        <div class="form-group">
                          <label>Discount %</label>
                          <input 
                            type="number" 
                            formControlName="purchaseDiscount" 
                            class="form-control"
                            [class.is-invalid]="isFieldInvalid(item.get('purchaseDiscount'))"
                            min="0"
                            max="100"
                            step="0.01"
                          >
                          <div class="invalid-feedback" *ngIf="isFieldInvalid(item.get('purchaseDiscount'))">
                            {{ item.get('purchaseDiscount')?.errors?.['min'] ? 'Discount must be greater than 0' : 
                               item.get('purchaseDiscount')?.errors?.['max'] ? 'Discount must be less than 100' : '' }}
                          </div>
                        </div>

                        <div class="form-group">
                          <label>Discount Amount</label>
                          <input 
                            type="number" 
                            formControlName="purchaseDiscountAmount" 
                            class="form-control"
                            min="0"
                            step="0.01"
                          >
                        </div>

                        <div class="form-group">
                          <label>Final Price</label>
                          <input 
                            type="number" 
                            formControlName="purchaseDiscountPrice" 
                            class="form-control"
                            readonly
                          >
                        </div>
                      </div>
                    </div>

                    <!-- Sale Section -->
                    <div class="sale-section">
                      <h6 class="section-title"><i class="fas fa-cash-register"></i> Sale Details</h6>
                      <div class="price-details">
                        <div class="form-group">
                          <label>Unit Price <span class="required">*</span></label>
                          <input 
                            type="number" 
                            formControlName="saleUnitPrice" 
                            class="form-control"
                            [class.is-invalid]="isFieldInvalid(item.get('saleUnitPrice'))"
                            min="0"
                            step="0.01"
                          >
                          <div class="invalid-feedback" *ngIf="isFieldInvalid(item.get('saleUnitPrice'))">
                            {{ item.get('saleUnitPrice')?.errors?.['required'] ? 'Unit price is required' : 
                               item.get('saleUnitPrice')?.errors?.['min'] ? 'Unit price must be greater than 0' : '' }}
                          </div>
                        </div>

                        <div class="form-group">
                          <label>Discount %</label>
                          <input 
                            type="number" 
                            formControlName="saleDiscount" 
                            class="form-control"
                            [class.is-invalid]="isFieldInvalid(item.get('saleDiscount'))"
                            min="0"
                            max="100"
                            step="0.01"
                          >
                          <div class="invalid-feedback" *ngIf="isFieldInvalid(item.get('saleDiscount'))">
                            {{ item.get('saleDiscount')?.errors?.['min'] ? 'Discount must be greater than 0' : 
                               item.get('saleDiscount')?.errors?.['max'] ? 'Discount must be less than 100' : '' }}
                          </div>
                        </div>

                        <div class="form-group">
                          <label>Discount Amount</label>
                          <input 
                            type="number" 
                            formControlName="saleDiscountAmount" 
                            class="form-control"
                            min="0"
                            step="0.01"
                          >
                        </div>

                        <div class="form-group">
                          <label>Final Price</label>
                          <input 
                            type="number" 
                            formControlName="saleDiscountPrice" 
                            class="form-control"
                            readonly
                          >
                        </div>
                      </div>
                    </div>

                    <!-- <div class="remarks-section">
                      <div class="form-group">
                        <label>Remarks</label>
                        <input 
                          type="text" 
                          formControlName="remarks" 
                          class="form-control"
                          placeholder="Optional remarks"
                        >
                      </div>
                    </div> -->

                    <button 
                      type="button" 
                      class="btn btn-danger remove-item-btn" 
                      (click)="onDeleteItem(bagIndex, itemIndex)"
                      [disabled]="getBagItems(bagIndex).length === 1"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="bags-header">
            <h3>Bags</h3>
            <button 
              type="button" 
              class="btn btn-primary add-bag-btn" 
              (click)="addBag()"
              [disabled]="loading"
            >
              <i class="fas fa-plus"></i> Add Bag
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="resetForm()"
            [disabled]="loading"
          >
            <i class="fas fa-undo"></i> Reset
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="transportForm.invalid || loading"
          >
            <i class="fas" [ngClass]="loading ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            {{ loading ? 'Saving...' : 'Save Transport' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<app-confirm-modal
  [show]="showDeleteBagModal"
  title="Delete Bag"
  message="Are you sure you want to delete this bag and all its items?"
  (confirm)="confirmDeleteBag()"
  (cancel)="cancelDelete()"
></app-confirm-modal>

<app-confirm-modal
  [show]="showDeleteItemModal"
  title="Delete Item"
  message="Are you sure you want to delete this item?"
  (confirm)="confirmDeleteItem()"
  (cancel)="cancelDelete()"
></app-confirm-modal>
