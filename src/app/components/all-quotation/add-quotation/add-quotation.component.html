<div class="add-quotation-container">
    <button class="btn btn-sm btn-secondary back-btn" routerLink="/quotation">
      <i class="fas fa-arrow-left"></i> Back to Quotations
    </button>
  
    <div class="form-card">
      <div class="card-header">
        <h2 class="form-title">
          <i class="fas" [ngClass]="isEdit ? 'fa-edit' : 'fa-plus'"></i>
          {{ isEdit ? 'Edit' : 'Create New' }} Quotation
        </h2>
      </div>
  
      <!-- create quotation section -->
      <form [formGroup]="quotationForm" (ngSubmit)="onSubmit()" (keydown.enter)="$event.preventDefault()"
        class="quotation-form">
        <div class="create-quotation-section">
          <div class="create-quotation-header">
            <h3><i class="fa-solid fa-receipt"></i> Create Quotation </h3>
          </div>
          <!-- Header Section -->
          <div class="header-section">
            <div class="form-row">
              <!-- Customer Selection -->
              <div class="form-group">
                <label>
                  <i class="fas fa-user"></i> Select Customer
                </label>
                <div class="select-group">
                  <app-searchable-select formControlName="customerId" [options]="customers" labelKey="name" valueKey="id"
                    [placeholder]="'Select Customer'" [searchPlaceholder]="'Search customers...'"></app-searchable-select>
                  <button type="button" class="btn btn-sm btn-primary refresh" style="margin-top: 3px;" (click)="refreshCustomers()"
                    [disabled]="isLoadingCustomers" title="Refresh Customers">
                    <i class="fas" [ngClass]="isLoadingCustomers ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                  </button>
                </div>
              </div>
  
              <!-- Customer Name -->
              <div class="form-group">
                <label>
                  <i class="fas fa-user-tag"></i> Customer Name <span class="required">*</span>
                </label>
                <input type="text" formControlName="customerName" class="form-control"
                  [class.is-invalid]="isFieldInvalid('customerName')" placeholder="Enter customer name" [readonly]="isCustomerIdSelected">
                <div class="invalid-feedback" *ngIf="isFieldInvalid('customerName')">
                  Customer name is required
                </div>
              </div>
  
              <!--Contact number -->
              <div class="form-group">
                <label>
                  <i class="fa-solid fa-phone"></i> Contact Number <span class="required">*</span>
                </label>
                <input type="text" formControlName="contactNumber" class="form-control"
                  [class.is-invalid]="isFieldInvalid('contactNumber')" placeholder="Enter contact number">
                <div class="invalid-feedback" *ngIf="isFieldInvalid('contactNumber')">
                  Contact Number is required
                </div>
              </div>
  
              <!-- customer address -->
              <div class="form-group">
                <label>
                  <i class="fa-solid fa-location-dot"></i> Address
                </label>
                <textarea formControlName="address" class="form-control" rows="3"
                  placeholder="Write customer address details..."></textarea>
              </div>
  
              <!-- Quote Date -->
              <div class="form-group">
                <label>
                  <i class="fas fa-calendar"></i> Quote Date
                </label>
                <input type="date" formControlName="quoteDate" class="form-control" readonly>
              </div>
  
              <!-- Valid Until -->
              <div class="form-group">
                <label>
                  <i class="fas fa-calendar-check"></i> Valid Until <span class="required">*</span>
                </label>
                <input type="date" formControlName="validUntil" class="form-control"
                  [class.is-invalid]="isFieldInvalid('validUntil')" [min]="minValidUntilDate">
                <div class="invalid-feedback" *ngIf="isFieldInvalid('validUntil')">
                  Valid until date is required and must be after quote date
                </div>
              </div>

              <!-- Transport Master -->
              <div class="form-group">
                <label>
                  <i class="fas fa-truck"></i> Transport
                </label>
                <div class="select-group">
                  <app-searchable-select formControlName="transportMasterId" [options]="transports" labelKey="name" valueKey="id"
                    [placeholder]="'Select Transport'" [searchPlaceholder]="'Search transports...'"></app-searchable-select>
                  <button type="button" class="btn btn-sm btn-primary refresh" style="margin-top: 3px;" (click)="refreshTransports()"
                    [disabled]="isLoadingTransports" title="Refresh Transports">
                    <i class="fas" [ngClass]="isLoadingTransports ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                  </button>
                </div>
              </div>

              <!-- Case Number -->
              <div class="form-group">
                <label>
                  <i class="fas fa-briefcase"></i> Case Number
                </label>
                <input type="text" formControlName="caseNumber" class="form-control" placeholder="Enter case number">
              </div>
            </div>
          </div>
        </div>
  
        <!-- Products Section -->
        <div class="products-section" formArrayName="items">
          <div class="products-header">
            <h3><i class="fas fa-boxes"></i> Products</h3>
            
            <div class="quotation-discount-wrapper">
              <div class="form-group quotation-discount-field">
                <label for="quotationDiscountPercentage">Quotation Discount {{quotationForm.get('quotationDiscountPercentage')?.value}} %</label>
                <div class="input-group">
                  <input 
                    type="number" 
                    id="quotationDiscountPercentage"
                    formControlName="quotationDiscountPercentage" 
                    class="form-control" 
                    min="0" 
                    max="100" 
                    step="0.01"
                    [class.is-invalid]="isFieldInvalid('quotationDiscountPercentage')"
                    (input)="onQuotationDiscountPercentageChange($event)"
                  >
                  <span class="input-group-text">%</span>
                </div>
                <div class="invalid-feedback" *ngIf="isFieldInvalid('quotationDiscountPercentage')">
                  Discount must be between 0 and 100
                </div>
              </div>
              
              <button type="button" class="btn btn-sm btn-primary" (click)="addItem()">
                <i class="fas fa-plus"></i> Add Product
              </button>
            </div>
          </div>
  
          <div class="table-responsive">
            <table class="table products-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Brand</th>
                  <th>Number of Roll</th>
                  <th>Weight Per Roll</th>
                  <th>Quantity</th>
                  <th>Unit Price</th>
                  <th>Remarks</th>
                  <th>Item Price</th>
                  <th>Quotation Discount</th>
                  <th>Tax (18%)</th>
                  <th>Final Price</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of itemsFormArray.controls; let i=index" [formGroupName]="i">
                  <!-- Product Selection -->
                  <td>
                    <div class="form-field-container">
                      <div class="select-group">
                        <app-searchable-select 
                          [formControlName]="'productId'" 
                          [options]="products" 
                          [labelKey]="'name'"
                          [valueKey]="'id'" 
                          [placeholder]="'Select Product'" 
                          [searchPlaceholder]="'Search products...'"
                          [class.is-invalid]="isItemFieldInvalid(i, 'productId')"
                          (selectionChange)="onProductSelect(i, $event)"
                        ></app-searchable-select>
                        <button 
                          type="button" 
                          class="btn btn-sm btn-primary refresh" 
                          (click)="refreshProducts()"
                          [disabled]="isLoadingProducts" 
                          title="Refresh Products"
                        >
                          <i class="fas" [ngClass]="isLoadingProducts ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                        </button>
                      </div>
                    </div>
                  </td>

                  <!-- Brand Selection -->
                  <td>
                    <div class="form-field-container">
                      <div class="select-group">
                        <app-searchable-select 
                          [formControlName]="'brandId'" 
                          [options]="brands" 
                          [labelKey]="'name'"
                          [valueKey]="'id'" 
                          [placeholder]="'Select Brand'" 
                          [searchPlaceholder]="'Search brands...'"
                          [class.is-invalid]="isItemFieldInvalid(i, 'brandId')"
                        ></app-searchable-select>
                        <button 
                          type="button" 
                          class="btn btn-sm btn-primary refresh" 
                          (click)="refreshBrands()"
                          [disabled]="isLoadingBrands" 
                          title="Refresh Brands"
                        >
                          <i class="fas" [ngClass]="isLoadingBrands ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                        </button>
                      </div>
                    </div>
                  </td>
  
                  <!-- Common fields -->
                  <td>
                    <div class="input-group">
                      <input type="number" formControlName="numberOfRoll" class="form-control"
                        [class.is-invalid]="isItemFieldInvalid(i, 'numberOfRoll')" min="0" step="1"
                        (input)="onRollWeightChange(i)">
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" formControlName="weightPerRoll" class="form-control"
                        [class.is-invalid]="isItemFieldInvalid(i, 'weightPerRoll')" min="0" step="0.01"
                        (input)="onRollWeightChange(i)">
                    </div>
                  </td>
                  <td>
                    <input type="number" formControlName="quantity" class="form-control"
                      [class.is-invalid]="isItemFieldInvalid(i, 'quantity')" min="0" step="0.001"
                      (input)="onQuantityEdit(i)">
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" formControlName="unitPrice" class="form-control"
                        [class.is-invalid]="isItemFieldInvalid(i, 'unitPrice')" min="0.01" step="0.01">
                      <span class="input-group-text" *ngIf="isLoadingPrices && loadingPriceIndex === i">
                        <i class="fas fa-spinner fa-spin"></i>
                      </span>
                      <!-- Optional debug information -->
                      <small *ngIf="false" class="form-text text-muted">
                        PID: {{item.get('productId')?.value}}
                      </small>
                    </div>
                  </td>
                  
                  <!-- Item Remarks -->
                  <td>
                    <input type="text" formControlName="remarks" class="form-control" placeholder="Remarks">
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" formControlName="price" class="form-control" readonly>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" formControlName="quotationDiscountAmount" class="form-control" readonly>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" formControlName="taxAmount" class="form-control" value="18" readonly>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" formControlName="finalPrice" class="form-control" readonly>
                    </div>
                  </td>
                  
                  <!-- Remarks -->
                  
                  <td>
                    <button type="button" (click)="removeItem(i)" class="btn btn-sm btn-danger">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="6" class="text-end"><strong>Total:</strong></td>
                  <td>
                    <div class="input-group">
                      <span class="input-group-text">₹</span>
                      <input type="number" [value]="totals.price" class="form-control" readonly>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" [value]="totals.quotationDiscountAmount" class="form-control" readonly>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" [value]="totals.tax" class="form-control" readonly>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <span class="input-group-text">₹</span>
                      <input type="number" [value]="totals.finalPrice" class="form-control" readonly>
                    </div>
                  </td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
  
        <!-- Additional Details -->
        <div class="d-flex mt-3">
          <div class="form-group w-50">
            <label>
              <i class="fas fa-comment"></i> Remarks
            </label>
            <textarea formControlName="remarks" class="form-control" rows="3" placeholder="Optional remarks"></textarea>
          </div>
  
          <div class="form-group w-50">
            <label>
              <i class="fas fa-file-contract"></i> Terms & Conditions
            </label>
            <textarea formControlName="termsConditions" class="form-control" rows="3"
              placeholder="Optional terms and conditions"></textarea>
          </div>
        </div>

        <!-- Packaging & Forwarding Charges -->
        <div class="d-flex mt-3">
          <div class="form-group w-50">
            <label>
              <i class="fas fa-box"></i> Packaging & Forwarding Charges
            </label>
            <input type="number" formControlName="packagingAndForwadingCharges" class="form-control" min="0" step="0.01">
          </div>
        </div>
  
        <!-- Summary Section -->
        <div class="quotation-summary">
          <div class="summary-item">
            <span>Total Products:</span>
            <strong>{{ itemsFormArray.length }}</strong>
          </div>
          <div class="summary-item">
            <span>Total Amount:</span>
            <strong>₹{{ getTotalAmount() | number:'1.2-2' }}</strong>
          </div>
        </div>
  
        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-sm btn-secondary" (click)="resetForm()" [disabled]="loading">
            <i class="fas fa-undo"></i> Reset
          </button>
          <button type="submit" class="btn btn-sm btn-primary" [disabled]="quotationForm.invalid || loading">
            <i class="fas" [ngClass]="loading ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            {{ isEdit ? loading ?  'Updating...' : 'Update Quotation' : loading ? 'Saving...' : 'Save Quotation' }}
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <app-loader *ngIf="loading"></app-loader>