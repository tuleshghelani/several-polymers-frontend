<div class="add-quotation-container">
  <button class="btn btn-sm btn-secondary back-btn" routerLink="/quotation">
    <i class="fas fa-arrow-left"></i> Back to Quotations
  </button>

  <div class="form-card">
    <div class="card-header">
      <h2 class="form-title">
        <i class="fas" [ngClass]="isEdit ? 'fa-edit' : 'fa-truck-loading'"></i>
        {{ isEdit ? 'Edit' : 'Dispatch' }} Quotation
      </h2>
    </div>

    <form [formGroup]="quotationForm" (ngSubmit)="onSubmit()" (keydown.enter)="$event.preventDefault()" class="quotation-form">
      <div class="create-quotation-section">
        <div class="create-quotation-header">
          <h3><i class="fa-solid fa-receipt"></i> Dispatch Quotation </h3>
        </div>
        <div class="header-section">
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user"></i> Select Customer</label>
              <div class="select-group">
                <app-searchable-select formControlName="customerId" [options]="customers" labelKey="name" valueKey="id" [placeholder]="'Select Customer'" [searchPlaceholder]="'Search customers...'"></app-searchable-select>
                <button type="button" class="btn btn-sm btn-primary refresh" style="margin-top: 3px;" (click)="refreshCustomers()" [disabled]="isLoadingCustomers" title="Refresh Customers">
                  <i class="fas" [ngClass]="isLoadingCustomers ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label><i class="fas fa-user-tag"></i> Customer Name <span class="required">*</span></label>
              <input type="text" formControlName="customerName" class="form-control" [class.is-invalid]="quotationForm.get('customerName')?.invalid" placeholder="Enter customer name" [readonly]="isCustomerIdSelected">
            </div>

            <div class="form-group">
              <label><i class="fas fa-id-card"></i> Reference Name</label>
              <input type="text" formControlName="referenceName" class="form-control" placeholder="Optional reference name">
            </div>

            <div class="form-group">
              <label><i class="fa-solid fa-phone"></i> Contact Number <span class="required">*</span></label>
              <input type="text" formControlName="contactNumber" class="form-control" [class.is-invalid]="quotationForm.get('contactNumber')?.invalid" placeholder="Enter contact number">
            </div>

            <div class="form-group">
              <label><i class="fa-solid fa-location-dot"></i> Address</label>
              <textarea formControlName="address" class="form-control" rows="3" placeholder="Write customer address details..."></textarea>
            </div>

            <div class="form-group">
              <label><i class="fas fa-calendar"></i> Quote Date</label>
              <input type="date" formControlName="quoteDate" class="form-control" readonly>
            </div>

            <div class="form-group">
              <label><i class="fas fa-calendar-check"></i> Valid Until <span class="required">*</span></label>
              <input type="date" formControlName="validUntil" class="form-control" [min]="minValidUntilDate">
            </div>

            <div class="form-group">
              <label><i class="fas fa-truck"></i> Transport</label>
              <div class="select-group">
                <app-searchable-select formControlName="transportMasterId" [options]="transports" labelKey="name" valueKey="id" [placeholder]="'Select Transport'" [searchPlaceholder]="'Search transports...'"></app-searchable-select>
                <button type="button" class="btn btn-sm btn-primary refresh" style="margin-top: 3px;" (click)="refreshTransports()" [disabled]="isLoadingTransports" title="Refresh Transports">
                  <i class="fas" [ngClass]="isLoadingTransports ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label><i class="fas fa-briefcase"></i> Case Number</label>
              <input type="text" formControlName="caseNumber" class="form-control" placeholder="Enter case number">
            </div>
          </div>
        </div>
      </div>

      <div class="products-section" formArrayName="items">
        <div class="products-header">
          <h3><i class="fas fa-boxes"></i> Products</h3>
          <button type="button" class="btn btn-sm btn-primary" (click)="addItem()">
            <i class="fas fa-plus"></i> Add Product
          </button>
        </div>

        <div class="table-responsive">
          <table class="table products-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Brand</th>
                <th>Number of Roll</th>
                <th>Weight Per Roll</th>
                <th>Quantity</th>
                <th>Remarks</th>
                <th>Is Production</th>
                <th>Status</th>
                <th>Created Roll</th>
                <!-- <th>Actions</th> -->
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of itemsFormArray.controls; let i=index" [formGroupName]="i">
                <td>
                  <div class="form-field-container">
                    <input type="text" formControlName="productName" class="form-control" placeholder="Product Name" readonly>
                  </div>
                </td>

                <td>
                  <div class="form-field-container">
                    <div class="select-group">
                      <input type="text" formControlName="brandName" class="form-control" placeholder="Brand" readonly>
                      <button 
                        type="button" 
                        class="btn btn-sm btn-primary refresh" 
                        (click)="refreshBrands()"
                        [disabled]="isLoadingBrands" 
                        title="Refresh Brands"
                      >
                        <i class="fas" [ngClass]="isLoadingBrands ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                      </button>
                    </div>
                  </div>
                </td>

                <td>
                  <div class="input-group">
                    <input type="number" formControlName="numberOfRoll" class="form-control" min="0" step="1" (input)="onRollWeightChange(i)" readonly>
                  </div>
                </td>
                <td>
                  <div class="input-group">
                    <input type="number" formControlName="weightPerRoll" class="form-control" min="0" step="0.01" (input)="onRollWeightChange(i)" readonly>
                  </div>
                </td>
                <td>
                  <input type="number" formControlName="quantity" class="form-control" min="0" step="0.001" (input)="onQuantityEdit(i)" readonly>
                </td>
                <td>
                  <input type="text" formControlName="remarks" class="form-control" placeholder="Remarks" readonly>
                </td>

                <td>
                  <input type="checkbox" formControlName="isProduction" (click)="onProductionClick(i, $event)" (change)="onProductionToggle(i)" title="Allowed only when status is Open">
                </td>
                <td>
                  <ng-container *ngIf="itemsFormArray.at(i).get('isProduction')?.value === true">
                    <select class="form-control" formControlName="quotationItemStatus" (change)="onStatusChange(i, $event)">
                      <option value="O">Open</option>
                      <option value="I">In progress</option>
                      <option value="C">Completed</option>
                      <option value="B">Billed</option>
                    </select>
                  </ng-container>
                </td>
                <td>
                  <input type="number" formControlName="createdRoll" class="form-control" min="0" step="1">
                </td>

                <!-- <td>
                  <button type="button" (click)="removeItem(i)" class="btn btn-sm btn-danger">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td> -->
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="d-flex mt-3">
        <div class="form-group w-50">
          <label><i class="fas fa-comment"></i> Remarks</label>
          <textarea formControlName="remarks" class="form-control" rows="3" placeholder="Optional remarks"></textarea>
        </div>

        <div class="form-group w-50">
          <label><i class="fas fa-file-contract"></i> Terms & Conditions</label>
          <textarea formControlName="termsConditions" class="form-control" rows="3" placeholder="Optional terms and conditions"></textarea>
        </div>
      </div>

      <div class="d-flex mt-3">
        <div class="form-group w-50">
          <label><i class="fas fa-box"></i> Packaging & Forwarding Charges</label>
          <input type="number" formControlName="packagingAndForwadingCharges" class="form-control" min="0" step="0.01">
        </div>
      </div>

      <!-- <div class="form-actions">
        <button type="button" class="btn btn-sm btn-secondary" (click)="quotationForm.reset()" [disabled]="loading">
          <i class="fas fa-undo"></i> Reset
        </button>
        <button type="submit" class="btn btn-sm btn-primary" [disabled]="quotationForm.invalid || loading">
          <i class="fas" [ngClass]="loading ? 'fa-spinner fa-spin' : 'fa-save'"></i>
          {{ isEdit ? loading ?  'Updating...' : 'Update' : loading ? 'Saving...' : 'Save' }}
        </button>
      </div> -->
    </form>
  </div>
</div>

<app-loader *ngIf="loading"></app-loader>


