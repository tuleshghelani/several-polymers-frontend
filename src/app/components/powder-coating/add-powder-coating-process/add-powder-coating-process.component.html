<div class="add-process-container">
  <button class="btn btn-secondary back-btn" routerLink="/powder-coating-process">
    <i class="fas fa-arrow-left"></i> Back to Processes
  </button>

  <div class="form-card">
    <div class="card-header">
      <h2 class="form-title">
        <i class="fas fa-spray-can"></i> {{ isEditMode ? 'Edit' : 'Add New' }} Powder Coating Process
      </h2>
    </div>
    
    <div class="form-content">
      <app-loader [show]="loading"></app-loader>
      
      <form [formGroup]="processForm" (ngSubmit)="onSubmit()" class="process-form" [class.loading]="loading">
        <!-- Basic Details Section -->
        <div class="section-card">
          <div class="form-row three-columns">
            <div class="form-group">
              <label for="customerId">
                <i class="fas fa-user"></i> Select Customer <span class="required">*</span>
              </label>
              <div class="select-group">
                <app-searchable-select
                  formControlName="customerId"
                  [options]="customers"
                  labelKey="name"
                  valueKey="id"
                  [placeholder]="'Select Customer'"
                  [class.is-invalid]="isFieldInvalid('customerId')"
                ></app-searchable-select>
                <button 
                  type="button" 
                  class="btn-icon refresh" 
                  (click)="refreshCustomers()" 
                  [disabled]="isLoadingCustomers"
                  title="Refresh Customers"
                >
                  <i class="fas" [ngClass]="isLoadingCustomers ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="productId">
                <i class="fas fa-box"></i> Select Product <span class="required">*</span>
              </label>
              <div class="select-group">
                <app-searchable-select
                  formControlName="productId"
                  [options]="products"
                  labelKey="name"
                  valueKey="id"
                  [placeholder]="'Select Product'"
                  [class.is-invalid]="isFieldInvalid('productId')"
                ></app-searchable-select>
                <button 
                  type="button" 
                  class="btn-icon refresh" 
                  (click)="refreshProducts()" 
                  [disabled]="isLoadingProducts"
                  title="Refresh Products"
                >
                  <i class="fas" [ngClass]="isLoadingProducts ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="remarks">
                <i class="fas fa-comment"></i> Remarks
              </label>
              <input 
                type="text"
                id="remarks"
                formControlName="remarks"
                class="form-control"
                placeholder="Optional remarks"
              >
            </div>
          </div>
        </div>

        <!-- Calculation Details Section -->
        <div class="section-card">
          <div class="form-row four-columns">
            <div class="form-group">
              <label for="quantity">
                <i class="fas fa-hashtag"></i> Quantity <span class="required">*</span>
              </label>
              <input type="number" id="quantity" formControlName="quantity" class="form-control"
                [class.is-invalid]="isFieldInvalid('quantity')" min="1">
              <div class="invalid-feedback">{{ getFieldError('quantity') }}</div>
            </div>

            <div class="form-group">
              <label for="totalBags">
                <i class="fas fa-shopping-bag"></i> Total Bags <span class="required">*</span>
              </label>
              <input type="number" id="totalBags" formControlName="totalBags" class="form-control"
                [class.is-invalid]="isFieldInvalid('totalBags')" min="1">
              <div class="invalid-feedback">{{ getFieldError('totalBags') }}</div>
            </div>

            <div class="form-group">
              <label for="unitPrice">
                <i class="fas fa-tag"></i> Unit Price <span class="required">*</span>
              </label>
              <input type="number" id="unitPrice" formControlName="unitPrice" class="form-control"
                [class.is-invalid]="isFieldInvalid('unitPrice')" min="0" step="0.01">
              <div class="invalid-feedback">{{ getFieldError('unitPrice') }}</div>
            </div>

            <div class="form-group">
              <label for="totalAmount">
                <i class="fas fa-calculator"></i> Total Amount
              </label>
              <input type="number" id="totalAmount" formControlName="totalAmount" class="form-control" readonly>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="loading">
            <i class="fas fa-undo"></i> Reset
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="processForm.invalid || loading">
            <i class="fas" [ngClass]="loading ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            {{ loading ? 'Saving...' : 'Save Process' }}
          </button>
        </div>
      </form>
    </div>
  </div>
<!-- </div> -->


<div class="returns-section card" *ngIf="isEditMode">
  <div class="returns-header" (click)="toggleReturns()" [class.expanded]="showReturns">
    <div class="header-content">
      <i class="fas fa-undo"></i>
      <h3>Process Returns</h3>
    </div>
    <i class="fas" [ngClass]="showReturns ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
  </div>

  <div class="returns-content" [class.expanded]="showReturns">
    <app-loader [show]="isLoadingReturns"></app-loader>
    
    <div class="table-actions">
      <button 
        class="btn btn-primary add-return-btn" 
        (click)="openReturnModal()"
        [disabled]="isLoadingReturns"
      >
        <i class="fas fa-plus"></i> Add Return
      </button>
    </div>

    <div class="table-responsive" [class.loading]="isLoadingReturns">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Return Quantity</th>
            <th>Return Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let return of returns; let i = index">
            <td>{{ i + 1 }}</td>
            <td>{{ return.returnQuantity }}</td>
            <td>{{ return.createdAt | date:'medium' }}</td>
            <td class="actions-cell">
              <button 
                class="btn btn-icon btn-danger" 
                (click)="deleteReturn(return.id)"
                [disabled]="isLoadingReturns"
                title="Delete Return"
              >
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="returns.length === 0">
            <td colspan="4" class="text-center">No returns found</td>
          </tr>
        </tbody>
        <tfoot *ngIf="returns.length > 0">
          <tr>
            <td><strong>Total Returns</strong></td>
            <td colspan="3"><strong>{{ getTotalReturns() }}</strong></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<app-return-modal (returnCreated)="loadReturns()"></app-return-modal>
</div>
